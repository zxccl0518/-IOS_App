## 机器人联网方式改进

传输使用 json 格式示例: 

```json
{
  	// STA 模式的字段, APP 通过网络连接
	"SN": "B10CN6670049",					// 当前设备的 SN 号
  	"ESSID": "TP-LINK_9FD5",				// 当前连接的 WIFI 名
  	"AccessPoint": "80:89:17:32:9F:D5",		// 当前接入点的 MAC 地址, Managed 模式的路由器地址
  	"Mode": "Managed",						// 当前设备的工作模式 Managed: STA, Master: AP...
  	"Frequency": "2.462 GHz",				// 当前的工作频率
  	"Quality": 5,							// 当前连接信号质量, 仅 Managed 模式
  
  	// AP 模式的字段, APP AP模式直连
  	"SN": "B10CN6670049",					// 当前设备的 SN 号
  	"ESSID": "MrBox-B10CN6670049",			// 当前自身 WIFI 名称
  	"AccessPoint": "84:5D:D7:4B:91:BD",		// 当前接入点的 MAC 地址, Master 模式是本机地址
  	"Mode": "Master",						// 当前设备的工作模式 Managed: STA, Master: AP...
  	"Frequency": "2.422 GHz",				// 当前的工作频率
 
  	// cells 数组内的项目是按照信号质量(Quality)排序的. 由高到低, 相同质量随机排序
  	"cell": [
    	{
        	"Address": "84:5D:D7:4B:92:48",	// MAC 地址
          	"ESSID": "MrBox-B10CN7180088",	// WIFI 名称
          	"Frequency": "2.417 GHz",		// 当前工作频率
          	"Channel": 2, 					// 1-13 范围工作通道
          	"Quality": 5, 					// 最大值 5, 最小 1
          	"Encryption": "off",			// 是否加密
            "registered": "yes",			// 是否保存	
          	"password":"",					// 密码, 无加密为空
    	},
        {
        	"Address": "28:6C:07:9C:DD:23",
          	"ESSID": "Robosys-PC",	
          	"Frequency": "2.437 GHz",
          	"Channel": 6, 			
          	"Quality": 5, 	
          	"Encryption": "on",				// wifi 加密
            "registered": "yes",			// wpa 里已保存	
          	"password":"roborobogo",		// 密码, 无加密为空            
    	},
    	{
        	"Address": "28:6C:07:9B:65:2E",
          	"ESSID": "JR Home",	
          	"Frequency": "2.412 GHz",
          	"Channel": 1, 	
          	"Quality": 4, 		
          	"Encryption": "on"	
          	"registered": "no"
    	}
  	]
  	
}
```



**需要确定和解决的问题:**

- Mode 是当前无线网卡的工作模式, 这里其实只有 Managed/Master 模式, :
     -   Managed: 被管理的客户端模式 / STA 模式
     -   Ad-Hoc: 无线客户端直连.
     -   Master: 主机模式, AP 模式.
     -   Repeater: 中继模式.
     -   Monitor : 监听模式, 一般是监听无线信道, 不直接连接任何主机或者客户端设备. 
     -   Secondary: Master/Repeater 的备份.
- registered 字段为 yes 的时候, password 字段才有意义. 否则不用解析.
- Encryption 用于 APP UI 显示有无锁标志.
- Quality 用于显示雷达标志等级.
- 所有字段的显示, 可以在 wifi 的详细信息里查看到.
- APP 上显示内容都要用中文名. 比如 Channel -> 通道. Address->硬件地址
- 需要对 wpa 文件里保存的wifi和上传的列表进行交集.  分出是否保存过.  即字段: registered = yes/no.
- APP 上显示的 WIFI 列表, 之前有无 registered 是可以知道的,  所以, 对于 registered = no 的网络, 直接弹出窗口提示输入密码, 且要支持输入完密码, 查看输入是否正确. 
- app 上显示的内容,  registere==yes 的 wifi, 点击后直接发送用户名(ESSID)和密码(password). ==支持查看和编辑 password==, 目的防止用户更改了密码.  配置后 wpa 里同名的 wifi 会覆盖旧的密码.  
- 讨论后决定不支持删除wifi, 对于 wifi 列表过长导致的联网缓慢问题, ==方法是支持类似手机的还原网络功能.== 
- 在App切换网络界面中，显示 WiFi 的信号质量(Quality)，有无密码(Encryption)，是否已保存过(registered)以及详细界面里的所有 json 字段信息(Address, ESSID, Frequency, Channel, Quality, Encryption, registered).
- 扫描 wifi 过多的情况, ==决定不做数量限制, 理由是: 绝大多数情况下, 扫描到的 wifi 都不会太多, 十几个的样子.==
- 扫描的过程会慢, 大约 2s 左右.  ==可忽略.==
- APP 在 wifi 列表界面时, 需不需要定时刷新列表?  ==决定不定时刷新, 只在进入界面是请求一次列表.==
- 除了上述 json 里的字段, 还需要其他字段吗? 比如加密方式? wpa2?  ==不需要.==
- 获取wifi列表的方式有两种:
     -   使用 iwlist 命令生成文件, 对文本进行解析操作获取所需要的字段. 
     -   ==使用 libiw 库, 调用接口生成结果. 需要调研一下.== 
- wifi的密码必须要进行连接后才能知道密码是否正确.  所以, 密码错了只能重新配置. 所以提供了上面的查看和编辑密码功能. 
- APP 发送完连接控制命令之后, 就切换到正常界面, 等待自动连接设备. 设备 AP 和在线模式都要支持自动连接. 
- 小盒可以做到自动切换信号强且连接过的网络么？ 可以做, 但是觉得没必要, 因为信号强不代表带宽/网速好.  信号不稳定, 容易误切换. 
- 是否可以将**配置网络**与**切换网络**整合在一起? 我觉得可以合并在一起, ==淡化配网, 突出切换.== 
- 切换网络时, 提示音需要重新设计, 胸灯, 表情, 耳朵灯什么的可以想怎么做.  ==等待产品定义细节.== 
     -   本来就是在线的, 切换网络成功, 按照现在的程序结构, 是没有提示音的. 是否需要? 
     -   本来是在线的, 切换网络失败, 会尝试连接网络两次, 无法连接, 进入离线. 会有进入离线的提示音, 如果连接成功, 没有提示音. 
     -   本来是离线的, 切换网络成功, 会提示小盒连网上了..blabla...
     -   本来是离线的, 切换网络失败, 也会有提示, 比如密码错误. 但并不是所有的错误原因都有提示. 
- APP 切换网络时, 是不知道当前所处的前端应用的. 有些前端应用会受到切换网络的影响. 所以如何做处理, 需要设计. 比如正在播放应用, 学习? 翻译? 脚本执行? 正在播放合成音? 这个时候做了网络切换, 切换的成功失败怎么处理?   ==等待产品定义细节.==




总体使用情况是, APP 只要连接了设备, 即可获取机器人自己扫描到的 wifi 列表, 下面这个是小盒扫描到的完整 wifi 信息. 

```shell
$ iwlist wlan0 scanning 
wlan0     Scan completed :
          Cell 01 - Address: 84:5D:D7:4B:92:48
                    ESSID:"MrBox-B10CN7180088"
                    Mode:Managed
                    Frequency:2.417 GHz (Channel 2)
                    Quality:5/5  Signal level:-57 dBm  Noise level:0 dBm
                    Encryption key:off
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
          Cell 02 - Address: 28:6C:07:9B:65:2E
                    ESSID:"JR Home"
                    Mode:Managed
                    Frequency:2.412 GHz (Channel 1)
                    Quality:4/5  Signal level:-62 dBm  Noise level:0 dBm
                    IE: IEEE 802.11i/WPA2 Version 1
                        Group Cipher : TKIP
                        Pairwise Ciphers (2) : TKIP CCMP
                        Authentication Suites (1) : PSK
                    IE: Unknown: DD7C0050F204104A0001101044000102103B000103104700102880288028801880A880286C079B652E102100067869616F6D6910230002523310240004303030321042000831323334353637381054000800060050F20400011011000C5869616F4D69526F7574657210080002210C103C0001011049000600372A000120
                    IE: WPA Version 1
                        Group Cipher : TKIP
                        Pairwise Ciphers (2) : TKIP CCMP
                        Authentication Suites (1) : PSK
                    Encryption key:on
                    Bit Rates:1 Mb/s; 2 Mb/s; 5.5 Mb/s; 6 Mb/s; 9 Mb/s
                              11 Mb/s; 12 Mb/s; 18 Mb/s; 24 Mb/s; 36 Mb/s
                              48 Mb/s; 54 Mb/s
 		 Cell 03 - Address: 28:6C:07:9C:DD:23
                    ESSID:"Robosys-PC"
                    Mode:Managed
                    Frequency:2.437 GHz (Channel 6)
                    Quality:5/5  Signal level:-39 dBm  Noise level:0 dBm
                    IE: IEEE 802.11i/WPA2 Version 1
                        Group Cipher : TKIP
                        Pairwise Ciphers (2) : TKIP CCMP
                        Authentication Suites (1) : PSK
                    IE: Unknown: DD7C0050F204104A0001101044000102103B000103104700102880288028801880A880286C079CDD23102100067869616F6D6910230002523310240004303030321042000831323334353637381054000800060050F20400011011000C5869616F4D69526F7574657210080002210C103C0001011049000600372A000120
                    IE: WPA Version 1
                        Group Cipher : TKIP
                        Pairwise Ciphers (2) : TKIP CCMP
                        Authentication Suites (1) : PSK
                    Encryption key:on
```

上传给小盒的结果是上面结果的裁剪, 如下: 

```shell
wlan0     Scan completed :
          Cell 01 - Address: 84:5D:D7:4B:92:48
                    ESSID:"MrBox-B10CN7180088"
                    Mode:Managed
                    Frequency:2.417 GHz (Channel 2)
                    Quality:5/5  Signal level:-57 dBm  Noise level:0 dBm
                    Encryption key:off
          Cell 02 - Address: 28:6C:07:9B:65:2E
                    ESSID:"JR Home"
                    Mode:Managed
                    Frequency:2.412 GHz (Channel 1)
                    Quality:4/5  Signal level:-62 dBm  Noise level:0 dBm
                    Encryption key:on
		  Cell 03 - Address: 28:6C:07:9C:DD:23
                    ESSID:"Robosys-PC"
                    Mode:Managed
                    Frequency:2.437 GHz (Channel 6)
                    Quality:5/5  Signal level:-39 dBm  Noise level:0 dBm
                    Encryption key:on
```

